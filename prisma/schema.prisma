
generator client {
  provider = "prisma-client-js"
}


datasource db {
  provider = "postgresql"
}

/* ========== Enums ========== */

enum SUBSCRIPTION_PLAN {
  PRO
  FREE
}

enum INTEGRATIONS {
  INSTAGRAM
  FACEBOOK
  GOOGLE
}

enum MEDIATYPE {
  IMAGE
  VIDEO
  CAROUSEL_ALBUM
}

enum LISTENERS {
  SMARTAI
  MESSAGE
}

/* ========== Models ========== */

model User {
  id            String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clerkId       String         @unique
  email         String         @unique
  firstname     String?
  lastname      String?
  createdAt     DateTime       @default(now())
  subscription  Subscription?
  integrations  Integration[]
  automations   Automation[]
  posts         Post[]
}

model Subscription {
  id            String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user          User?           @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId        String?         @unique @db.Uuid
  plan          SUBSCRIPTION_PLAN @default(FREE)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @default(now()) @updatedAt
  customerId    String?         @unique
}

model Integration {
  id            String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          INTEGRATIONS  @default(INSTAGRAM)
  createdAt     DateTime      @default(now())
  user          User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId        String?       @db.Uuid
  token         String?
  expiresAt     DateTime?
  instagramId   String?       @unique
}

/* ---------- Automation & related models ---------- */

model Automation {
  id          String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String     @default("Untitled")
  createdAt   DateTime   @default(now())
  active      Boolean    @default(false)
  trigger     Trigger[]
  listener    Listener? 
  posts       Post[]
  dms         Dm[]
  keywords    Keyword[]
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String     @db.Uuid
}

model Trigger {
  id             String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type           String
  automation     Automation? @relation(fields: [automationId], references: [id], onDelete: Cascade)
  automationId   String?     @db.Uuid
  createdAt      DateTime    @default(now())
}

model Listener {
  id             String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  automation     Automation  @relation(fields: [automationId], references: [id], onDelete: Cascade)
  automationId   String      @unique @db.Uuid // Made unique to enforce 1:1 relation
  listener       LISTENERS   @default(MESSAGE)
  prompt         String?
  commentReply   String?
  dmCount        Int         @default(0)
  commentCount   Int         @default(0)
  createdAt      DateTime    @default(now())

  @@unique([automationId, listener])
}

model Keyword {
  id             String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  word           String

  automation     Automation? @relation(fields: [automationId], references: [id], onDelete: Cascade)
  automationId   String?     @db.Uuid

  @@unique([automationId, word])
}

model Post {
  id             String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  postid         String
  caption        String?
  media          String?
  mediaType      MEDIATYPE   @default(IMAGE)
  createdAt      DateTime    @default(now())

  // RELATIONSHIPS
  // This relation links the post to the automation that might have created it
  automation     Automation? @relation(fields: [automationId], references: [id], onDelete: Cascade)
  automationId   String?     @db.Uuid
  
  // *** FIX: Added missing relation back to the User model ***
  user           User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String      @db.Uuid
}

/* ---------- Direct Messages (DMs) ---------- */

model Dm {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt       DateTime @default(now())

  // relation to Automation (optional)
  automation      Automation? @relation(fields: [automationId], references: [id], onDelete: Cascade)
  automationId    String?  @db.Uuid

  // sender / receiver references
  senderId        String?  @db.Uuid
  receiverId      String?  @db.Uuid

  message         String?

  @@index([senderId])
  @@index([receiverId])
}